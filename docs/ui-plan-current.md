# План UI (MCP7) — текущая версия

Основан на `process.md`: цель — вернуть логику в БД/FDW, убрать дубли/мёртвый код и довести UI до операторского уровня. Отмечай галочками по мере выполнения.

## Добавление (новое)
- [x] core->infrastructure->ui/tests: Поддержка многопрофильной работы central/anpz/krnpz. Маршрутизация `sp_insert_measurement_batch` в нужную БД через FDW, статус профиля в UI. Файлы: `src/OilErp.Infrastructure/Adapters/StorageAdapter.cs` (env + профиль), `src/OilErp.Core/Contracts/IStoragePort.cs` (новый контракт), `src/OilErp.Core/Dto/DatabaseProfile.cs`, `src/OilErp.Tests.Runner/Program.cs` (TestEnvironment/ANPZ-команда), `src/OilErp.Ui/ViewModels/MainWindowViewModel.cs`/`ConnectionFormViewModel.cs` (автозаполнение, профиль в статусе). Добавлен тест `Fake_Storage_Subscribe_Unsubscribe`.
- [x] core->infrastructure->ui/tests: Режим живых данных в UI (top-CR + `fn_asset_summary_json` с plant/risk/updated_at, live/snapshot статус). Обновить VM/виды под это. Файлы: `src/OilErp.Ui/Services/MeasurementDataProvider.cs` (используется), `src/OilErp.Ui/ViewModels/AnalyticsPanelViewModel.cs`, `src/OilErp.Ui/ViewModels/MainWindowViewModel.cs`, `src/OilErp.Ui/Views/MainWindow.axaml`.
- [x] core->infrastructure->ui/tests: Инжест замеров из UI/CLI с транзакцией, выбором завода и повторной загрузкой аналитики; запросы идут в заводские процедуры, затем ingest central. Файлы: `src/OilErp.Ui/Services/MeasurementIngestionService.cs`, `src/OilErp.Ui/ViewModels/AddMeasurementFormViewModel.cs`, `src/OilErp.Tests.Runner/Program.cs` (add-measurements), `src/OilErp.Core/Services/Plants/*`.
- [x] core->infrastructure->ui/tests: Диагностика LISTEN/NOTIFY для ingest/событий с выводом в UI и CLI (`watch`) без кастов к адаптеру. Файлы: `IStoragePort` (новые методы), `StorageAdapter`, `src/OilErp.Tests.Runner/Program.cs` (watch), VM/разметка диагностики в UI.
- [x] core->infrastructure->ui/tests: MCP-секции/дашборды (Overview/Plants/Analytics/Diagnostics) на реальных DTO (cr, risk, очередь событий), без заглушек. Файлы: `src/OilErp.Ui/Views/MainWindow.axaml`, VM для измерений/диагностики/аналитики, подключение `MeasurementDataProvider`.

## Обновление (исправление/упрощение)
- [x] core->infrastructure->ui/tests: Единая конфигурация подключения (`TestEnvironment.LoadStorageConfig()`/env) для CLI/Tests/UI; `KernelGateway`/ConnectionForm используют её по умолчанию. Файлы: `src/OilErp.Tests.Runner/Program.cs`, `src/OilErp.Ui/Services/KernelGateway.cs`, `src/OilErp.Ui/ViewModels/ConnectionFormViewModel.cs`.
- [x] core->infrastructure: Расширить `IStoragePort` (begin/commit/rollback + subscribe/unsubscribe) и убрать reflection/касты; `StorageAdapter` реализует интерфейс. Файлы: `src/OilErp.Core/Contracts/IStoragePort.cs`, `src/OilErp.Infrastructure/Adapters/StorageAdapter.cs`, потребители в CLI/тестах/UI.
- [x] core->infrastructure->ui: Перенести агрегацию CR/P90 в SQL или минимизировать N+1 в `PlantCrService`; в UI выводить plant из summary. Файлы: `src/OilErp.Core/Services/Aggregations/PlantCrService.cs`, `src/OilErp.Core/Services/Central/FnPlantCrStatsService.cs`, SQL `sql/central/02_functions_core.sql`, `src/OilErp.Infrastructure/Readme.Mapping.md`, `src/OilErp.Ui/ViewModels/AnalyticsPanelViewModel.cs`.
- [x] ui: Задействовать `MeasurementDataProvider`, `MeasurementSnapshotService`, `MeasurementIngestionService`, `McpSectionViewModel`, диагностику; убрать ручные JSON-поля, добавить валидацию/статусы. Файлы: `src/OilErp.Ui/ViewModels/MainWindowViewModel.cs`, `src/OilErp.Ui/Views/MainWindow.axaml`, `src/OilErp.Ui/Services/*`, VM измерений/диагностики.
- [x] tests: Добавить сценарии для заводского пути (агрегации по plant), LISTEN, базовые проверки уведомлений; убрать дублирующие smoke-посевы одной выборки. Файлы: `src/OilErp.Tests.Runner/Smoke/StorageSmoke.cs` (Plant_Cr_Stats_Match_Seed), `src/OilErp.Tests.Runner/Smoke/AsyncSmokeTests.cs` (Subscribe/Unsubscribe, Listen_Notify_Roundtrip).

## Удаление (лишнее/мешающее)
- [x] core->infrastructure->ui/tests: Удалить/отключить офлайн InMemoryStoragePort и связанные пути — работа только с БД. Файлы: `src/OilErp.Ui/Services/InMemoryStoragePort.cs`, его использования (если остались).
- [x] core/ui: Убрать дубли (`AnalyticsService` vs `FnAssetSummaryJsonService`) и мёртвые VM/placeholder-вью. Файлы: `src/OilErp.Core/Services/Central/AnalyticsService.cs`, неиспользуемые VM/Views после интеграции.
- [x] infra/tests: Исключить зависимости на тестовые утилиты в прод-сборках (линки `AppLogger`, `DatabaseInventory` в csproj); вынести прод-логгер отдельно. Файлы: `src/OilErp.Infrastructure/OilErp.Infrastructure.csproj` (AppLogger копия), `src/OilErp.Ui/OilErp.Ui.csproj` (собственные AppLogger/Bootstrapper/Inventory/FirstRun).
